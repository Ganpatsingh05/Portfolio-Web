<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex,nofollow">
    <title>Portfolio Admin Dashboard</title>
    <!-- Local Tailwind build (served by backend at /gdash.css) -->
    <link rel="stylesheet" href="/gdash.css">
    <!-- Alpine.js -->
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div x-data="adminApp()" x-init="init()">
        <!-- Login Screen -->
        <div x-show="!isAuthenticated" class="min-h-screen flex items-center justify-center">
            <div class="bg-white p-8 rounded-lg shadow-md w-96">
                <h2 class="text-2xl font-bold mb-6 text-center">Admin Login</h2>
                <form @submit.prevent="login()">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Username:</label>
                        <input 
                            type="text" 
                            x-model="credentials.username"
                            class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                            required
                        >
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                        <div class="relative">
                            <input 
                                :type="showPassword ? 'text' : 'password'" 
                                x-model="credentials.password"
                                class="w-full px-3 py-2 pr-10 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                required
                            >
                            <button 
                                type="button"
                                @click="showPassword = !showPassword"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
                            >
                                <svg x-show="!showPassword" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                <svg x-show="showPassword" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L8.464 8.464m1.414 1.414L9.878 9.878m5.658 5.658l1.414 1.414M15.536 15.536L14.122 14.122m1.414 1.414L16.95 17.05m-3.415-3.414L12.12 12.12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button 
                        type="submit" 
                        class="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 disabled:opacity-50"
                        :disabled="loading"
                    >
                        <span x-show="!loading">Login</span>
                        <span x-show="loading">Logging in...</span>
                    </button>
                </form>
                <div x-show="error" class="mt-4 text-red-500 text-sm" x-text="error"></div>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div x-show="isAuthenticated" class="min-h-screen">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b">
                <div class="flex justify-between items-center px-6 py-4">
                    <h1 class="text-2xl font-bold text-gray-800">Portfolio Admin Dashboard</h1>
                    <button 
                        @click="logout()" 
                        class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
                    >
                        Logout
                    </button>
                </div>
            </header>

            <!-- Navigation -->
            <nav class="bg-gray-800 text-white">
                <div class="px-6">
                    <div class="flex space-x-8">
                        <button 
                            @click="activeTab = 'dashboard'" 
                            :class="activeTab === 'dashboard' ? 'border-b-2 border-blue-400 bg-gray-700/40 rounded-t-md text-blue-300' : 'text-gray-200'"
                            class="py-4 px-3 hover:text-blue-300 transition-colors"
                        >
                            Dashboard
                        </button>
                        <button 
                            @click="activeTab = 'personal'" 
                            :class="activeTab === 'personal' ? 'border-b-2 border-blue-400 bg-gray-700/40 rounded-t-md text-blue-300' : 'text-gray-200'"
                            class="py-4 px-3 hover:text-blue-300 transition-colors"
                        >
                            Personal Info
                        </button>
                        <button 
                            @click="activeTab = 'projects'" 
                            :class="activeTab === 'projects' ? 'border-b-2 border-blue-400 bg-gray-700/40 rounded-t-md text-blue-300' : 'text-gray-200'"
                            class="py-4 px-3 hover:text-blue-300 transition-colors"
                        >
                            Projects
                        </button>
                        <button 
                            @click="activeTab = 'skills'" 
                            :class="activeTab === 'skills' ? 'border-b-2 border-blue-400 bg-gray-700/40 rounded-t-md text-blue-300' : 'text-gray-200'"
                            class="py-4 px-3 hover:text-blue-300 transition-colors"
                        >
                            Skills
                        </button>
                        <button 
                            @click="activeTab = 'experience'" 
                            :class="activeTab === 'experience' ? 'border-b-2 border-blue-400 bg-gray-700/40 rounded-t-md text-blue-300' : 'text-gray-200'"
                            class="py-4 px-3 hover:text-blue-300 transition-colors"
                        >
                            Experience
                        </button>
                        <button 
                            @click="activeTab = 'messages'" 
                            :class="activeTab === 'messages' ? 'border-b-2 border-blue-400 bg-gray-700/40 rounded-t-md text-blue-300' : 'text-gray-200'"
                            class="py-4 px-3 hover:text-blue-300 transition-colors"
                        >
                            Messages
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Content -->
            <main class="p-6">
                <!-- Dashboard Tab -->
                <div x-show="activeTab === 'dashboard'">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold">Dashboard Overview</h2>
                        <button @click="fetchDashboardStats()" class="inline-flex items-center gap-2 px-3 py-2 rounded-md text-sm bg-blue-600 text-white hover:bg-blue-700 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4"><path d="M2.25 8.25a6.75 6.75 0 0112.653-2.66.75.75 0 001.394-.58A8.25 8.25 0 103.75 15h1a.75.75 0 000-1.5h-1a6.75 6.75 0 01-1.5-5.25z"/><path d="M12 6.75a.75.75 0 01.75.75v3.75H16.5a.75.75 0 010 1.5h-4.5V7.5A.75.75 0 0112 6.75z"/></svg>
                            Refresh
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow group hover:shadow-md transition transform hover:-translate-y-0.5 border-l-4 border-blue-500">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-semibold text-gray-600">Projects</h3>
                                <div class="rounded-full p-2 bg-blue-50 text-blue-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5A2.25 2.25 0 015.25 5.25h13.5A2.25 2.25 0 0121 7.5v9A2.25 2.25 0 0118.75 18.75H5.25A2.25 2.25 0 013 16.5v-9z" />
                                    </svg>
                                </div>
                            </div>
                            <p class="text-3xl font-bold text-blue-600" x-text="dashboardStats.projects"></p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow group hover:shadow-md transition transform hover:-translate-y-0.5 border-l-4 border-green-500">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-semibold text-gray-600">Skills</h3>
                                <div class="rounded-full p-2 bg-green-50 text-green-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-7.5 8.25h9a2.25 2.25 0 002.25-2.25v-9A2.25 2.25 0 0016.5 5.25h-9A2.25 2.25 0 005.25 7.5v9A2.25 2.25 0 007.5 18z" />
                                    </svg>
                                </div>
                            </div>
                            <p class="text-3xl font-bold text-green-600" x-text="dashboardStats.skills"></p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow group hover:shadow-md transition transform hover:-translate-y-0.5 border-l-4 border-amber-500">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-semibold text-gray-600">Messages</h3>
                                <div class="rounded-full p-2 bg-amber-50 text-amber-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5A2.25 2.25 0 0119.5 19.5h-15A2.25 2.25 0 012.25 17.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15A2.25 2.25 0 002.25 6.75m19.5 0L12 12.75 2.25 6.75" />
                                    </svg>
                                </div>
                            </div>
                            <p class="text-3xl font-bold text-yellow-600" x-text="dashboardStats.messages"></p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow group hover:shadow-md transition transform hover:-translate-y-0.5 border-l-4 border-purple-500">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-semibold text-gray-600">Views</h3>
                                <div class="rounded-full p-2 bg-purple-50 text-purple-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </div>
                            </div>
                            <p class="text-3xl font-bold text-purple-600" x-text="dashboardStats.pageViews"></p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow group hover:shadow-md transition transform hover:-translate-y-0.5 border-l-4 border-slate-500">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-semibold text-gray-600">Resume</h3>
                                <div class="rounded-full p-2 bg-slate-50 text-slate-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625A2.625 2.625 0 0016.875 9h-9.75A2.625 2.625 0 004.5 11.625V14.25m15 0a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 14.25m15 0V8.25A2.25 2.25 0 0017.25 6h-10.5A2.25 2.25 0 004.5 8.25v6" />
                                    </svg>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <div x-show="personalInfo.resume_url" class="flex items-center text-green-600">
                                    <svg class="w-8 h-8 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="font-bold">Uploaded</span>
                                </div>
                                <div x-show="!personalInfo.resume_url" class="flex items-center text-red-600">
                                    <svg class="w-8 h-8 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="font-bold">Missing</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Messages -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-6 border-b">
                            <h3 class="text-lg font-semibold">Recent Messages</h3>
                        </div>
                        <div class="p-6">
                            <template x-for="message in recentMessages" :key="message.id">
                                <div class="border-b pb-4 mb-4 last:border-b-0">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="font-semibold" x-text="message.name"></h4>
                                            <p class="text-gray-600" x-text="message.email"></p>
                                            <p class="text-sm text-gray-500 mt-2" x-text="message.message"></p>
                                        </div>
                                        <span class="text-xs text-gray-400" x-text="formatDate(message.created_at)"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Personal Info Tab -->
                <div x-show="activeTab === 'personal'">
                    <h2 class="text-xl font-bold mb-6">Personal Information</h2>
                    <div class="bg-white rounded-lg shadow">
                        <form @submit.prevent="updatePersonalInfo()" class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                                    <input 
                                        type="text" 
                                        x-model="personalInfo.name"
                                        class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                        required
                                    >
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                    <input 
                                        type="text" 
                                        x-model="personalInfo.title"
                                        class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                        required
                                    >
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input 
                                        type="email" 
                                        x-model="personalInfo.email"
                                        class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                        required
                                    >
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                                    <input 
                                        type="text" 
                                        x-model="personalInfo.location"
                                        class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                        required
                                    >
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">GitHub URL</label>
                                    <input 
                                        type="url" 
                                        x-model="personalInfo.github_url"
                                        class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                    >
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">LinkedIn URL</label>
                                    <input 
                                        type="url" 
                                        x-model="personalInfo.linkedin_url"
                                        class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                    >
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">LeetCode URL</label>
                                    <input 
                                        type="url" 
                                        x-model="personalInfo.leetcode_url"
                                        class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                    >
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Resume URL</label>
                                    <input 
                                        type="url" 
                                        x-model="personalInfo.resume_url"
                                        class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                    >
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Current Resume</label>
                                    <div class="mb-3 p-3 bg-gray-50 rounded border">
                                        <div x-show="personalInfo.resume_url" class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <svg class="w-5 h-5 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                                                </svg>
                                                <span class="text-sm text-gray-700">Resume uploaded</span>
                                            </div>
                                            <div class="flex space-x-2">
                                                <a :href="personalInfo.resume_url" target="_blank" 
                                                   class="text-blue-500 hover:text-blue-700 text-sm">
                                                    View
                                                </a>
                                                <button @click="personalInfo.resume_url = ''; alert('Resume URL cleared. Don\'t forget to save.')"
                                                        class="text-red-500 hover:text-red-700 text-sm">
                                                    Remove
                                                </button>
                                            </div>
                                        </div>
                                        <div x-show="!personalInfo.resume_url" class="text-sm text-gray-500">
                                            No resume uploaded yet
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload New Resume</label>
                                    <div class="space-y-2">
                                        <input 
                                            type="file" 
                                            accept=".pdf"
                                            @change="handleResumeUpload($event)"
                                            class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                            :disabled="loading"
                                        >
                                        <div class="flex items-center justify-between text-sm">
                                            <p class="text-gray-500">Upload a PDF file (max 5MB)</p>
                                            <div x-show="uploadProgress > 0 && uploadProgress < 100" class="flex items-center">
                                                <div class="w-20 bg-gray-200 rounded-full h-2 mr-2">
                                                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                                                         :style="`width: ${uploadProgress}%`"></div>
                                                </div>
                                                <span x-text="`${uploadProgress}%`" class="text-blue-600 font-medium"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Degree</label>
                                    <input 
                                        type="text" 
                                        x-model="personalInfo.degree"
                                        class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                        placeholder="e.g., Bachelor's in Computer Science"
                                    >
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">University</label>
                                    <input 
                                        type="text" 
                                        x-model="personalInfo.university"
                                        class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                        placeholder="e.g., University Name"
                                    >
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Education Period</label>
                                    <input 
                                        type="text" 
                                        x-model="personalInfo.education_period"
                                        class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                        placeholder="e.g., 2023-2027"
                                    >
                                </div>
                            </div>
                            <div class="mt-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                                <textarea 
                                    x-model="personalInfo.bio"
                                    rows="4"
                                    class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                    placeholder="Brief description about yourself..."
                                ></textarea>
                            </div>
                            <div class="mt-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Journey</label>
                                <textarea 
                                    x-model="personalInfo.journey"
                                    rows="4"
                                    class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                    placeholder="Your professional journey and background..."
                                ></textarea>
                            </div>
                            <div class="mt-6">
                                <button 
                                    type="submit" 
                                    class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600"
                                    :disabled="loading"
                                >
                                    <span x-show="!loading">Update Personal Info</span>
                                    <span x-show="loading">Updating...</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Projects Tab -->
                <div x-show="activeTab === 'projects'">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Projects</h2>
                        <button 
                            @click="showProjectModal = true; editingProject = null; resetProjectForm()"
                            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                        >
                            Add Project
                        </button>
                    </div>

                    <div class="bg-white rounded-lg shadow">
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Technologies</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                <tbody class="divide-y divide-gray-200">
                                    <template x-for="project in projects" :key="project.id">
                    <tr class="hover:bg-gray-50 transition-colors">
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div>
                                                    <div class="text-sm font-medium text-gray-900" x-text="project.title"></div>
                                                    <div class="text-sm text-gray-500" x-text="project.description.substring(0, 100) + '...'"></div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="project.category"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="Array.isArray(project.technologies) ? project.technologies.join(', ') : project.technologies"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button 
                                                    @click="editProject(project)"
                                                    class="text-blue-600 hover:text-blue-900 mr-3"
                                                >
                                                    Edit
                                                </button>
                                                <button 
                                                    @click="deleteProject(project.id)"
                                                    class="text-red-600 hover:text-red-900"
                                                >
                                                    Delete
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Skills Tab -->
                <div x-show="activeTab === 'skills'">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Skills</h2>
                        <button 
                            @click="showSkillModal = true; editingSkill = null; resetSkillForm()"
                            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                        >
                            Add Skill
                        </button>
                    </div>

                    <div class="bg-white rounded-lg shadow">
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Level</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                <tbody class="divide-y divide-gray-200">
                                    <template x-for="skill in skills" :key="skill.id">
                    <tr class="hover:bg-gray-50 transition-colors">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="skill.name"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="skill.category"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <div class="flex items-center">
                                                    <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                                        <div class="h-2 rounded-full" :class="skillBarClass(skill)" :style="`width: ${skill.level}%`"></div>
                                                    </div>
                                                    <span x-text="skill.level + '%'"></span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button 
                                                    @click="editSkill(skill)"
                                                    class="text-blue-600 hover:text-blue-900 mr-3"
                                                >
                                                    Edit
                                                </button>
                                                <button 
                                                    @click="deleteSkill(skill.id)"
                                                    class="text-red-600 hover:text-red-900"
                                                >
                                                    Delete
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Experience Tab -->
                <div x-show="activeTab === 'experience'">
                    <h2 class="text-xl font-bold mb-6">Experience Management</h2>
                    
                    <!-- Add Experience Button -->
                    <div class="mb-6">
                        <button 
                            @click="showExperienceForm = true; editingExperience = null; resetExperienceForm()"
                            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                        >
                            Add Experience
                        </button>
                    </div>

                    <!-- Experience List -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="p-6">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                                        <template x-for="experience in experiences" :key="experience.id">
                        <tr class="hover:bg-gray-50 transition-colors">
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="text-sm font-medium text-gray-900" x-text="experience.title"></div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="text-sm text-gray-900" x-text="experience.company"></div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="text-sm text-gray-900" x-text="experience.period"></div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span 
                                                        :class="experience.type === 'experience' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'"
                                                        class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                                        x-text="experience.type === 'experience' ? 'Work' : 'Education'"
                                                    ></span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                    <button 
                                                        @click="editExperience(experience)"
                                                        class="text-blue-600 hover:text-blue-900 mr-2"
                                                    >
                                                        Edit
                                                    </button>
                                                    <button 
                                                        @click="deleteExperience(experience.id)"
                                                        class="text-red-600 hover:text-red-900"
                                                    >
                                                        Delete
                                                    </button>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Experience Form Modal -->
                    <div x-show="showExperienceForm" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" x-cloak>
                        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
                            <div class="mt-3">
                                <h3 class="text-lg font-medium text-gray-900 mb-4" x-text="editingExperience ? 'Edit Experience' : 'Add Experience'"></h3>
                                <form @submit.prevent="saveExperience()">
                                    <div class="grid grid-cols-1 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Title</label>
                                            <input 
                                                type="text" 
                                                x-model="experienceForm.title"
                                                class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                required
                                            >
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Company/Institution</label>
                                            <input 
                                                type="text" 
                                                x-model="experienceForm.company"
                                                class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                required
                                            >
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Period</label>
                                            <input 
                                                type="text" 
                                                x-model="experienceForm.period"
                                                placeholder="e.g., Jan 2023 - Present"
                                                class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                required
                                            >
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Type</label>
                                            <select 
                                                x-model="experienceForm.type"
                                                class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                required
                                            >
                                                <option value="">Select Type</option>
                                                <option value="experience">Work Experience</option>
                                                <option value="education">Education</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Description</label>
                                            <textarea 
                                                x-model="experienceForm.description"
                                                rows="4"
                                                class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                placeholder="Describe your role, achievements, and key responsibilities..."
                                            ></textarea>
                                        </div>
                                    </div>
                                    <div class="flex justify-end space-x-3 mt-6">
                                        <button 
                                            type="button"
                                            @click="showExperienceForm = false"
                                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
                                        >
                                            Cancel
                                        </button>
                                        <button 
                                            type="submit"
                                            class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600"
                                            :disabled="loading"
                                        >
                                            <span x-show="!loading" x-text="editingExperience ? 'Update' : 'Add'"></span>
                                            <span x-show="loading">Saving...</span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages Tab -->
                <div x-show="activeTab === 'messages'">
                    <h2 class="text-xl font-bold mb-6">Contact Messages</h2>
                    <div class="bg-white rounded-lg shadow">
                        <div class="divide-y divide-gray-200">
                            <template x-for="message in messages" :key="message.id">
                                <div class="p-6">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="flex items-center mb-2">
                                                <h3 class="text-lg font-semibold" x-text="message.name"></h3>
                                                <span 
                                                    x-show="(message.status ? message.status !== 'read' : !message.is_read)"
                                                    class="ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full"
                                                >
                                                    NEW
                                                </span>
                                            </div>
                                            <p class="text-gray-600 mb-2" x-text="message.email"></p>
                                            <p class="text-gray-800 mb-4" x-text="message.message"></p>
                                            <p class="text-sm text-gray-500" x-text="formatDate(message.created_at)"></p>
                                        </div>
                                        <button 
                                            x-show="(message.status ? message.status !== 'read' : !message.is_read)"
                                            @click="markAsRead(message.id)"
                                            class="ml-4 bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600"
                                        >
                                            Mark as Read
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Project Modal -->
        <div x-show="showProjectModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4">
                <h3 class="text-lg font-semibold mb-4" x-text="editingProject ? 'Edit Project' : 'Add New Project'"></h3>
                <form @submit.prevent="saveProject()">
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                            <input 
                                type="text" 
                                x-model="projectForm.title"
                                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                required
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea 
                                x-model="projectForm.description"
                                rows="3"
                                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                required
                            ></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                <input 
                                    type="text" 
                                    x-model="projectForm.category"
                                    class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Technologies</label>
                                <input 
                                    type="text" 
                                    x-model="projectForm.technologies"
                                    class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                    placeholder="React, Node.js, MongoDB"
                                >
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Demo URL</label>
                                <input 
                                    type="url" 
                                    x-model="projectForm.demo_url"
                                    class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">GitHub URL</label>
                                <input 
                                    type="url" 
                                    x-model="projectForm.github_url"
                                    class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                >
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button 
                            type="button" 
                            @click="showProjectModal = false"
                            class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50"
                        >
                            Cancel
                        </button>
                        <button 
                            type="submit" 
                            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                        >
                            Save Project
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Skill Modal -->
        <div x-show="showSkillModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                <h3 class="text-lg font-semibold mb-4" x-text="editingSkill ? 'Edit Skill' : 'Add New Skill'"></h3>
                <form @submit.prevent="saveSkill()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                            <input 
                                type="text" 
                                x-model="skillForm.name"
                                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                required
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                            <div class="space-y-2">
                                <select 
                                    x-model="skillForm.category"
                                    class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                    required
                                >
                                    <option value="">Select Category</option>
                                    <option value="frontend">Frontend</option>
                                    <option value="backend">Backend</option>
                                    <option value="database">Database</option>
                                    <option value="tools">Tools</option>
                                    <option value="language">Language</option>
                                    <option value="other">Other</option>
                                    <option value="custom">Custom…</option>
                                </select>
                                <input 
                                    x-show="skillForm.category === 'custom'"
                                    type="text" 
                                    placeholder="Enter custom category"
                                    x-model="skillForm.customCategory"
                                    class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
                                >
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Level (0-100)</label>
                            <input 
                                type="range" 
                                min="0" 
                                max="100" 
                                x-model="skillForm.level"
                                class="w-full"
                            >
                            <div class="text-center mt-1" x-text="skillForm.level + '%'"></div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button 
                            type="button" 
                            @click="showSkillModal = false"
                            class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50"
                        >
                            Cancel
                        </button>
                        <button 
                            type="submit" 
                            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                        >
                            Save Skill
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tailwind safelist for dynamic classes used in Alpine bindings -->
    <div class="hidden">
        <span class="bg-fuchsia-600"></span>
        <span class="bg-teal-600"></span>
        <span class="bg-blue-600"></span>
        <span class="bg-emerald-600"></span>
        <span class="bg-amber-600"></span>
        <span class="bg-slate-600"></span>
        <span class="bg-violet-600"></span>
        <span class="bg-indigo-600"></span>
    </div>

    <script>
        // Rewrite any localhost API calls to relative /api for production safety
        (function() {
            const LHOST = 'http://localhost:5000';
            const origFetch = window.fetch.bind(window);
            window.fetch = function(input, init) {
                try {
                    if (typeof input === 'string' && input.startsWith(LHOST + '/api')) {
                        return origFetch(input.replace(LHOST, ''), init);
                    }
                    if (input && typeof input === 'object' && 'url' in input && input.url && input.url.startsWith(LHOST + '/api')) {
                        const req = new Request(input, init);
                        return origFetch(new Request(req.url.replace(LHOST, ''), req), init);
                    }
                } catch (_) {
                    // fall through to original fetch
                }
                return origFetch(input, init);
            };
        })();

        function adminApp() {
            return {
                // Authentication
                isAuthenticated: false,
                credentials: { username: '', password: '' },
                token: '',
                error: '',
                loading: false,
                showPassword: false,

                // Navigation
                activeTab: 'dashboard',

                // Dashboard data
                dashboardStats: { projects: 0, skills: 0, messages: 0, pageViews: 0 },
                recentMessages: [],

                // Personal Info
                personalInfo: {},
                uploadProgress: 0,

                // Projects
                projects: [],
                showProjectModal: false,
                editingProject: null,
                projectForm: {},

                // Skills
                skills: [],
                showSkillModal: false,
                editingSkill: null,
                skillForm: { level: 50 },

                // Experience
                experiences: [],
                showExperienceForm: false,
                editingExperience: null,
                experienceForm: {},

                // Messages
                messages: [],

                init() {
                    // Check for stored token
                    this.token = localStorage.getItem('adminToken');
                    if (this.token) {
                        // Try a lightweight authenticated request to confirm token validity
                        fetch('/api/admin/dashboard', {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        }).then(resp => {
                            if (resp.status === 401) {
                                // Invalid/expired token
                                localStorage.removeItem('adminToken');
                                this.token = '';
                                this.isAuthenticated = false;
                            } else if (resp.ok) {
                                this.isAuthenticated = true;
                                this.loadDashboard();
                            }
                        }).catch(() => {
                            // Connection issue – keep on login screen
                            this.isAuthenticated = false;
                        });
                    }
                },

                async login() {
                    this.loading = true;
                    this.error = '';

                    try {
                        const response = await fetch('/api/admin/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.credentials)
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.token = data.token;
                            this.isAuthenticated = true;
                            localStorage.setItem('adminToken', this.token);
                            this.loadDashboard();
                        } else {
                            this.error = data.error || 'Login failed';
                        }
                    } catch (error) {
                        this.error = 'Connection error';
                    }

                    this.loading = false;
                },

                logout() {
                    this.isAuthenticated = false;
                    this.token = '';
                    localStorage.removeItem('adminToken');
                    this.credentials = { username: '', password: '' };
                },

                async loadDashboard() {
                    await Promise.all([
                        this.fetchDashboardStats(),
                        this.fetchPersonalInfo(),
                        this.fetchProjects(),
                        this.fetchSkills(),
                        this.fetchExperiences(),
                        this.fetchMessages()
                    ]);
                },

        async fetchDashboardStats() {
                    try {
                        // Fetch aggregated stats from backend admin dashboard
                        const dashResp = await fetch('/api/admin/dashboard', {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });

                        if (dashResp.status === 401) {
                            // Token invalid – force logout
                            this.logout();
                            return;
                        }
                        if (dashResp.ok) {
                            const dash = await dashResp.json();
                            // Update dashboard stats (from backend counts)
                            this.dashboardStats = {
                                projects: dash.stats?.projects || 0,
                                skills: dash.stats?.skills || 0,
                                messages: dash.stats?.messages || 0,
                                pageViews: dash.stats?.pageViews || 0
                            };
                            // Set recent messages (last 5)
                            this.recentMessages = Array.isArray(dash.recentMessages) ? dash.recentMessages.slice(0,5) : [];
                        }
                    } catch (error) {
                        console.error('Error fetching dashboard stats:', error);
                    }
                },

                async fetchPersonalInfo() {
                    try {
                        const response = await fetch('/api/admin/personal-info', {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });
                        if (response.status === 401) {
                            this.logout();
                            return;
                        }
                        if (response.ok) {
                            this.personalInfo = await response.json();
                        }
                    } catch (error) {
                        console.error('Error fetching personal info:', error);
                    }
                },

                async updatePersonalInfo() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/admin/personal-info', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify(this.personalInfo)
                        });

                        if (response.status === 401) {
                            this.logout();
                            return;
                        }
                        if (response.ok) {
                            const result = await response.json();
                            this.personalInfo = result; // Update with server response
                            alert('Personal information updated successfully!');
                        } else {
                            const error = await response.json();
                            throw new Error(error.error || 'Failed to update personal information');
                        }
                    } catch (error) {
                        console.error('Error updating personal info:', error);
                        alert(`Error updating personal information: ${error.message}`);
                    } finally {
                        this.loading = false;
                    }
                },

                async handleResumeUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    if (file.type !== 'application/pdf') {
                        alert('Please select a PDF file');
                        event.target.value = '';
                        return;
                    }

                    if (file.size > 5 * 1024 * 1024) { // 5MB limit
                        alert('File size must be less than 5MB');
                        event.target.value = '';
                        return;
                    }

                    this.loading = true;
                    this.uploadProgress = 0;
                    
                    try {
                        const formData = new FormData();
                        formData.append('resume', file);

                        // Simulate upload progress (since Cloudinary doesn't provide real progress)
                        const progressInterval = setInterval(() => {
                            if (this.uploadProgress < 90) {
                                this.uploadProgress += Math.random() * 15;
                            }
                        }, 200);

            const response = await fetch('/api/admin/upload/resume', {
                            method: 'POST',
                            headers: {
                'Authorization': `Bearer ${this.token}`
                            },
                            body: formData
                        });

                        clearInterval(progressInterval);
                        this.uploadProgress = 100;

                        if (response.status === 401) {
                            this.logout();
                            return;
                        }
                        if (response.ok) {
                            const result = await response.json();
                            this.personalInfo.resume_url = result.url;
                            // Immediately persist resume_url so it survives refresh
                            try {
                                const saveResp = await fetch('/api/admin/personal-info', {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${this.token}`
                                    },
                                    body: JSON.stringify({ resume_url: this.personalInfo.resume_url })
                                });
                                if (saveResp.status === 401) {
                                    this.logout();
                                    return;
                                }
                                if (saveResp.ok) {
                                    this.personalInfo = await saveResp.json();
                                    alert(`Resume uploaded and saved successfully!\nFile: ${result.originalName}`);
                                } else {
                                    const err = await saveResp.json().catch(() => ({}));
                                    alert(`Resume uploaded, but failed to save profile: ${err.error || 'Unknown error'}`);
                                }
                            } catch (e) {
                                alert('Resume uploaded, but failed to save profile due to connection error.');
                            }

                            // Clear the file input
                            event.target.value = '';
                            
                            // Reset progress after a delay
                            setTimeout(() => {
                                this.uploadProgress = 0;
                            }, 2000);
                        } else {
                            const error = await response.json();
                            throw new Error(error.error || 'Failed to upload resume');
                        }
                    } catch (error) {
                        console.error('Error uploading resume:', error);
                        alert(`Error uploading resume: ${error.message}`);
                        this.uploadProgress = 0;
                        // Clear the file input on error
                        event.target.value = '';
                    } finally {
                        this.loading = false;
                    }
                },

                async fetchProjects() {
                    try {
                        // Prefer admin endpoint (auth) for consistency
                        const response = await fetch('/api/admin/projects', {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });
                        if (response.status === 401) {
                            this.logout();
                            return;
                        }
                        if (response.ok) {
                            const payload = await response.json();
                            this.projects = Array.isArray(payload) ? payload : (payload?.data || []);
                        } else {
                            // Fallback to public endpoint if needed
                            const pub = await fetch('/api/projects');
                            if (pub.ok) {
                                const payload = await pub.json();
                                this.projects = Array.isArray(payload) ? payload : (payload?.data || []);
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching projects:', error);
                    }
                },

                resetProjectForm() {
                    this.projectForm = {
                        title: '',
                        description: '',
                        category: '',
                        technologies: '',
                        demo_url: '',
                        github_url: ''
                    };
                },

                editProject(project) {
                    this.editingProject = project;
                    this.projectForm = { 
                        ...project,
                        demo_url: project.demo_url || project.live_url || '',
                        technologies: Array.isArray(project.technologies) ? project.technologies.join(', ') : (project.technologies || '')
                    };
                    this.showProjectModal = true;
                },

                async saveProject() {
                    try {
                        const url = this.editingProject 
                            ? `/api/admin/projects/${this.editingProject.id}`
                            : '/api/admin/projects';
                        
                        const method = this.editingProject ? 'PUT' : 'POST';

                        // Convert technologies string to array
                        const payload = {
                            ...this.projectForm,
                            technologies: typeof this.projectForm.technologies === 'string' 
                                ? this.projectForm.technologies.split(',').map(t => t.trim()).filter(t => t)
                                : (this.projectForm.technologies || [])
                        };

                        const response = await fetch(url, {
                            method,
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify(payload)
                        });

                        if (response.status === 401) {
                            this.logout();
                            return;
                        }
                        if (response.ok) {
                            this.showProjectModal = false;
                            this.fetchProjects();
                            alert('Project saved successfully!');
                        } else {
                            const error = await response.json();
                            throw new Error(error.error || 'Failed to save project');
                        }
                    } catch (error) {
                        console.error('Error saving project:', error);
                        alert(`Error saving project: ${error.message}`);
                    }
                },

                async deleteProject(id) {
                    if (confirm('Are you sure you want to delete this project?')) {
                        try {
                            const response = await fetch(`/api/admin/projects/${id}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${this.token}` }
                            });

                            if (response.status === 401) {
                                this.logout();
                                return;
                            }
                            if (response.ok) {
                                this.fetchProjects();
                                alert('Project deleted successfully!');
                            }
                        } catch (error) {
                            alert('Error deleting project');
                        }
                    }
                },

                async fetchSkills() {
                    try {
                        // Use authenticated admin endpoint for skills
                        const response = await fetch('/api/admin/skills', {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });
                        if (response.status === 401) {
                            this.logout();
                            return;
                        }
                        if (response.ok) {
                            const payload = await response.json();
                            const list = Array.isArray(payload) ? payload : (payload?.data || []);
                            this.skills = this.sortSkills(list);
                        } else {
                            // Fallback to public endpoint
                            const fallback = await fetch('/api/skills');
                            if (fallback.ok) {
                                const payload = await fallback.json();
                                const list = Array.isArray(payload) ? payload : (payload?.data || []);
                                this.skills = this.sortSkills(list);
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching skills:', error);
                    }
                },

                // Sort skills by category (asc), then level (desc), then name (asc)
                sortSkills(list) {
                    const catOrder = (c) => (c || '').toString().toLowerCase();
                    return (list || []).slice().sort((a, b) => {
                        const ca = catOrder(a.category);
                        const cb = catOrder(b.category);
                        if (ca < cb) return -1;
                        if (ca > cb) return 1;
                        const la = Number(a.level) || 0;
                        const lb = Number(b.level) || 0;
                        if (la !== lb) return lb - la; // desc by level
                        const na = (a.name || '').toLowerCase();
                        const nb = (b.name || '').toLowerCase();
                        if (na < nb) return -1;
                        if (na > nb) return 1;
                        return 0;
                    });
                },

                // Return Tailwind class for bar color based on category
                skillBarClass(skill) {
                    const cat = (skill?.category || '').toString().toLowerCase();
                    if (cat === 'custom') return 'bg-fuchsia-600';
                    if (cat === 'other') return 'bg-teal-600';
                    if (cat === 'frontend') return 'bg-blue-600';
                    if (cat === 'backend') return 'bg-emerald-600';
                    if (cat === 'database') return 'bg-amber-600';
                    if (cat === 'tools') return 'bg-slate-600';
                    if (cat === 'language') return 'bg-violet-600';
                    return 'bg-indigo-600';
                },

                resetSkillForm() {
                    this.skillForm = {
                        name: '',
                        category: '',
                        customCategory: '',
                        level: 50
                    };
                },

                editSkill(skill) {
                    this.editingSkill = skill;
                    this.skillForm = { ...skill, customCategory: '' };
                    this.showSkillModal = true;
                },

                                async saveSkill() {
                    try {
                        const url = this.editingSkill 
                            ? `/api/admin/skills/${this.editingSkill.id}`
                            : '/api/admin/skills';
                        
                        const method = this.editingSkill ? 'PUT' : 'POST';

                                                // Normalize category and types for backend validators
                                                const payload = {
                                                        ...this.skillForm,
                                                        level: Number(this.skillForm.level),
                                                        category: this.skillForm.category === 'custom' 
                                                            ? (this.skillForm.customCategory || 'custom')
                                                            : this.skillForm.category
                                                };

                                                const response = await fetch(url, {
                            method,
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                                                        body: JSON.stringify(payload)
                        });

                        if (response.status === 401) {
                            this.logout();
                            return;
                        }
                        if (response.ok) {
                            this.showSkillModal = false;
                            await this.fetchSkills();
                            this.skills = this.sortSkills(this.skills);
                            alert('Skill saved successfully!');
                        } else {
                            const error = await response.json();
                            throw new Error(error.error || 'Failed to save skill');
                        }
                    } catch (error) {
                        console.error('Error saving skill:', error);
                        alert(`Error saving skill: ${error.message}`);
                    }
                },

                async deleteSkill(id) {
                    if (confirm('Are you sure you want to delete this skill?')) {
                        try {
                            const response = await fetch(`/api/admin/skills/${id}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${this.token}` }
                            });

                            if (response.status === 401) {
                                this.logout();
                                return;
                            }
                            if (response.ok) {
                                this.fetchSkills();
                                alert('Skill deleted successfully!');
                            }
                        } catch (error) {
                            alert('Error deleting skill');
                        }
                    }
                },

                // Experience Management
                async fetchExperiences() {
                    try {
                        const response = await fetch('/api/admin/experiences', {
                            headers: { 'Authorization': `Bearer ${this.token}` }
                        });

                        if (response.status === 401) {
                            this.logout();
                            return;
                        }
                        if (response.ok) {
                            this.experiences = await response.json();
                        }
                    } catch (error) {
                        console.error('Error fetching experiences:', error);
                    }
                },

                resetExperienceForm() {
                    this.experienceForm = {
                        title: '',
                        company: '',
                        period: '',
                        type: '',
                        description: ''
                    };
                },

                editExperience(experience) {
                    this.editingExperience = experience;
                    this.experienceForm = { ...experience };
                    this.showExperienceForm = true;
                },

                async saveExperience() {
                    this.loading = true;
                    try {
                        const url = this.editingExperience 
                            ? `/api/admin/experiences/${this.editingExperience.id}`
                            : '/api/admin/experiences';
                        
                        const method = this.editingExperience ? 'PUT' : 'POST';

                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify(this.experienceForm)
                        });

                        if (response.status === 401) {
                            this.logout();
                            return;
                        }
                        if (response.ok) {
                            this.showExperienceForm = false;
                            this.fetchExperiences();
                            alert(`Experience ${this.editingExperience ? 'updated' : 'added'} successfully!`);
                        }
                    } catch (error) {
                        alert('Error saving experience');
                    } finally {
                        this.loading = false;
                    }
                },

                async deleteExperience(id) {
                    if (confirm('Are you sure you want to delete this experience?')) {
                        try {
                            const response = await fetch(`/api/admin/experiences/${id}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${this.token}` }
                            });

                            if (response.status === 401) {
                                this.logout();
                                return;
                            }
                            if (response.ok) {
                                this.fetchExperiences();
                                alert('Experience deleted successfully!');
                            }
                        } catch (error) {
                            alert('Error deleting experience');
                        }
                    }
                },

        async fetchMessages() {
                    try {
            const response = await fetch('/api/contact');

                        if (response.ok) {
                            this.messages = await response.json();
                        }
                    } catch (error) {
                        console.error('Error fetching messages:', error);
                    }
                },

                async markAsRead(id) {
                    try {
                        const response = await fetch(`/api/contact/${id}/status`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ status: 'read' })
                        });

                        if (response.ok) {
                            this.fetchMessages();
                            this.fetchDashboardStats();
                        }
                    } catch (error) {
                        alert('Error marking message as read');
                    }
                },

                formatDate(dateString) {
                    return new Date(dateString).toLocaleDateString() + ' ' + new Date(dateString).toLocaleTimeString();
                }
            }
        }
    </script>
</body>
</html>
